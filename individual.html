<!DOCTYPE html>
<html lang="en">

<head>
  <title>PGP Encrypt Files</title>
  <script src="lib/openpgp.js"></script>
</head>

<body>
  <div id="container">
    <h1>
      PGP Encrypt Files
    </h1>
    <hr>

    <h4>Upload File</h4>
    <form>
      <input type="file" id="file" name="filename">
    </form>

    <h4>Upload Public Key File</h4>
    <form>
      <input type="file" id="pubKey" name="pubKey">
    </form>
    <br />

    <form>
      <button type="button" onClick="return encryptAndDownload()">Download</button>
    </form>

  </div>
</body>

</html>

<script>
  checkIfFileAPISupported();

  downloadURL = function (url, fileName) {
    const a = document.createElement('a');
    a.href = url;
    a.download = fileName;
    document.body.appendChild(a);
    a.style = 'display: none';
    a.click();
    a.remove();
  };

  function download(fileName, encryptedFile) {
    const blob = new Blob([encryptedFile], {
      type: 'application/octet-stream'
    });
    url = window.URL.createObjectURL(blob);
    downloadURL(url, fileName);
  }

  function checkIfFileAPISupported() {
    if (window.File && window.FileReader && window.FileList && window.Blob) {
      console.log("File API supported!");
    } else {
      console.log('The File API is not fully supported in this browser.');
    }
  }

  async function encryptAndDownload() {
    const fileInput = document.getElementById('file');
    const filePath = fileInput.value;
    const data = fileInput.files[0];
    const fileName = filePath.replace(/^.*[\\\/]/, '');

    const pubKeyInput = document.getElementById('pubKey');
    const rawPubKey = pubKeyInput.files[0];
    const pubKey = await getText(rawPubKey);

    const encryptedFile = await encryptFile(data, pubKey);
    download(`${fileName}.pgp`, encryptedFile);
    document.getElementById("file").value = "";
  }

  var getArrayBuffer = (blob) => new Promise(function (resolve) {
    var reader = new FileReader();
    reader.onloadend = function () {
      resolve(reader.result);
    };
    reader.readAsArrayBuffer(blob);
  });

  var getText = (blob) => new Promise(function (resolve) {
    var reader = new FileReader();
    reader.onloadend = function () {
      resolve(reader.result);
    };
    reader.readAsText(blob);
  });

  async function encryptFile(data, pubKey) {
    const publicKeysArmored = [pubKey];

    const arrayBufferData = await getArrayBuffer(data)

    const publicKeys = await Promise.all(publicKeysArmored.map(armoredKey => openpgp.readKey({ armoredKey })));

    const encryptedFile = await openpgp.encrypt({
      message: await openpgp.createMessage({ binary: new Uint8Array(arrayBufferData) }),
      encryptionKeys: publicKeys,
      format: 'binary'
    })

    return encryptedFile;
  };
</script>

<style>
  body {
    width: 100%;
    margin: auto;
  }

  #container {
    padding: 30px;
  }
</style>
